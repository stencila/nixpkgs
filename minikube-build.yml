# An example Kubernetes deployment for building Nixster environments
# Designed for testing using Minikube but should
# require little modification for use in a production cluster.

apiVersion: batch/v1
kind: Job
metadata:
  name: nixster-build-job
spec:
  backoffLimit: 4
  template:
    spec:
      restartPolicy: Never
      # Prevent Kubernetes setting `NIXSTER_SERVICE_*` environment variables
      # which makes the `nixster` CLI tool complain about unrecognised options
      # because of the `NIXTER_` prefix clash.
      enableServiceLinks: false
      initContainers:
        # Create the `profiles` directory
        # This is a workaround which could be avoided by a fix in the `nixster` app
        - name: init-nix-volumne
          image: busybox
          command: ["sh", "-c", "mkdir -p /nixroot/nix/profiles/"]
          volumeMounts:
            - name: nix-volume
              mountPath: /nixroot
      containers:
        # Build container with write access to the `/nixroot` directory
        - name: build-container
          image: stencila/nixster
          # Don't pull image, instead use the one built locally
          imagePullPolicy: Never
          # Build the environment into the `/nixroot` directory
          # To keep thing fast and small only build a small image
          command: ["nixster"]
          args: ["build", "r", "--store", "/nixroot"]
          volumeMounts:
            - name: nix-volume
              mountPath: /nixroot
          # Build needs to be priviledged
          securityContext:
            privileged: true
      # Use the ReadWriteOnce PVC
      volumes:
        - name: nix-volume
          persistentVolumeClaim:
            claimName: nixster-pvc-rwo
